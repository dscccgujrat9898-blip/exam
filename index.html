<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SSC Exam Portal (Single Bank, No Upload)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#0b1220;--card:#111d3b;--txt:#eaf1ff;--mut:#aab7d2;--pri:#2b5cff;--bad:#ef4444;}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{margin:0;background:var(--bg);color:var(--txt);}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;background:rgba(11,18,32,.92);backdrop-filter:blur(10px);z-index:10;}
    .brand{font-weight:900}
    .timer{font-variant-numeric:tabular-nums;font-weight:900}
    .container{max-width:1200px;margin:0 auto;padding:14px;}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);cursor:pointer;font-weight:800}
    .tab.active{background:rgba(43,92,255,.22);border-color:rgba(43,92,255,.6)}
    .grid{display:grid;grid-template-columns: 1fr 320px;gap:14px;margin-top:14px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;box-shadow:0 10px 40px rgba(0,0,0,.25);}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-size:12px;color:var(--mut);display:block;margin:6px 0 6px}
    select,input{width:100%;padding:10px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f1b34;color:var(--txt)}
    button{border:0;border-radius:12px;padding:10px 12px;background:var(--pri);color:white;font-weight:900;cursor:pointer}
    button.sec{background:transparent;border:1px solid rgba(255,255,255,.16)}
    button.dng{background:var(--bad)}
    .small{font-size:12px;color:var(--mut);line-height:1.5}
    .hide{display:none}
    .qmeta{display:flex;gap:10px;flex-wrap:wrap;color:var(--mut);font-size:12px}
    .qtext{font-size:16px;line-height:1.4;margin:10px 0 12px}
    .opt{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:12px;margin:8px 0;cursor:pointer}
    .opt input{width:auto;margin-top:3px}
    .opt.sel{border-color:rgba(43,92,255,.7);background:rgba(43,92,255,.12)}
    .palette{display:grid;grid-template-columns: repeat(6, 1fr);gap:8px}
    .pbtn{padding:8px 0;text-align:center;border-radius:10px;font-weight:900;cursor:pointer;border:1px solid rgba(255,255,255,.10);background:#0f1b34}
    .pbtn.ans{outline:2px solid rgba(34,197,94,.55)}
    .pbtn.rev{outline:2px solid rgba(245,158,11,.55)}
    .pbtn.cur{background:rgba(43,92,255,.25);border-color:rgba(43,92,255,.6)}
    .stat{display:flex;justify-content:space-between;padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:12px;margin:8px 0;background:rgba(0,0,0,.12)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);font-size:12px;color:var(--mut)}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px}
    .err{color:#ffb4b4}
  </style>
</head>
<body>
<header>
  <div class="brand">SSC Exam Portal (Single Bank, No Upload)</div>
  <div class="timer" id="timer">00:00:00</div>
</header>

<div class="container">
  <div class="tabs" id="tabs"></div>

  <div class="grid">
    <div class="card">
      <div id="portal">
        <div class="small">
          ✅ No Upload. Only one file is used: <code>bank/Bank.xlsx</code> (Sheet: <code>QUESTIONS</code>)
        </div>
        <div style="height:10px"></div>

        <div class="row">
          <div style="flex:1;min-width:220px">
            <label>Language</label>
            <select id="lang"><option value="HI">Hindi</option><option value="EN">English</option></select>
          </div>
          <div style="flex:1;min-width:220px">
            <label>Mode</label>
            <select id="mode"><option value="FULL">Full Mock (Exam Pattern)</option><option value="CUSTOM">Custom Practice</option></select>
          </div>
          <div style="flex:1;min-width:220px" id="customCountWrap" class="hide">
            <label>Questions</label>
            <input id="count" type="number" value="25" min="5" max="200"/>
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div style="flex:1;min-width:220px">
            <label>Candidate Name</label>
            <input id="candName" placeholder="e.g., Rahul Kumar"/>
          </div>
          <div style="flex:1;min-width:220px">
            <label>Roll No.</label>
            <input id="roll" placeholder="Optional"/>
          </div>
          <div style="flex:1;min-width:220px">
            <label>Category</label>
            <select id="cat"><option>UR</option><option>OBC</option><option>SC</option><option>ST</option><option>EWS</option></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;align-items:center;justify-content:space-between">
          <div class="pill" id="patternPill"></div>
          <div class="row">
            <button class="sec" id="resetSeen">Reset Anti-Repeat</button>
            <button id="goInstructions">Continue</button>
          </div>
        </div>

        <div class="small" id="status" style="margin-top:10px"></div>
        <div class="small err" id="validator" style="margin-top:6px"></div>
      </div>

      <div id="instructions" class="hide">
        <h2 style="margin:0 0 8px">Instructions</h2>
        <div class="small" id="instText"></div>
        <div class="row" style="margin-top:12px">
          <button class="sec" id="backPortal">Back</button>
          <button id="startBtn">I am ready to begin</button>
        </div>
      </div>

      <div id="examUI" class="hide">
        <div class="qmeta" id="qmeta"></div>
        <div class="qtext" id="qtext"></div>
        <div id="opts"></div>
        <div class="row" style="margin-top:10px">
          <button class="sec" id="prevBtn">Prev</button>
          <button class="sec" id="markBtn">Mark</button>
          <button class="sec" id="clearBtn">Clear</button>
          <button id="nextBtn">Next</button>
          <button class="dng" id="submitBtn">Submit</button>
        </div>
      </div>

      <div id="resultUI" class="hide">
        <h2 style="margin:0 0 8px">Result</h2>
        <div class="stat"><div>Exam</div><div id="rExam"></div></div>
        <div class="stat"><div>Candidate</div><div id="rCand"></div></div>
        <div class="stat"><div>Total</div><div id="rTotal"></div></div>
        <div class="stat"><div>Correct</div><div id="rCorrect"></div></div>
        <div class="stat"><div>Wrong</div><div id="rWrong"></div></div>
        <div class="stat"><div>Unattempted</div><div id="rUnatt"></div></div>
        <div class="stat"><div>Score</div><div id="rScore"></div></div>
        <div class="stat"><div>Accuracy</div><div id="rAcc"></div></div>
        <div class="row" style="margin-top:10px">
          <button id="newBtn">Back to Portal</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-weight:900">Palette</div>
        <div class="small" id="progress">0/0</div>
      </div>
      <div style="height:10px"></div>
      <div class="palette" id="palette"></div>
      <div style="height:10px"></div>
      <div class="small">Green outline = Answered<br/>Orange outline = Marked</div>
    </div>
  </div>
</div>

<script>
  const $ = (id)=>document.getElementById(id);

  const EXAMS = {
    CHSL: {title:"SSC CHSL (Tier-1)", durationMin:60, totalQ:100, sections:[
      {name:"General Intelligence", q:25, subject:"Reasoning"},
      {name:"Quantitative Aptitude", q:25, subject:"Quant"},
      {name:"English", q:25, subject:"English"},
      {name:"General Awareness", q:25, subject:"GK"},
    ]},
    CGL: {title:"SSC CGL (Tier-1)", durationMin:60, totalQ:100, sections:[
      {name:"General Intelligence", q:25, subject:"Reasoning"},
      {name:"General Awareness", q:25, subject:"GK"},
      {name:"Quantitative Aptitude", q:25, subject:"Quant"},
      {name:"English", q:25, subject:"English"},
    ]},
    GD: {title:"SSC GD (CBT)", durationMin:60, totalQ:80, sections:[
      {name:"Reasoning", q:20, subject:"Reasoning"},
      {name:"GK & GA", q:20, subject:"GK"},
      {name:"Elementary Maths", q:20, subject:"Quant"},
      {name:"English/Hindi", q:20, subject:"English"},
    ]},
    STENO: {title:"SSC Stenographer (CBT)", durationMin:120, totalQ:200, sections:[
      {name:"General Intelligence & Reasoning", q:50, subject:"Reasoning"},
      {name:"General Awareness", q:50, subject:"GK"},
      {name:"English Language", q:100, subject:"English"},
    ]},
    CPO: {title:"SSC CPO (Paper-1 CBT)", durationMin:120, totalQ:200, sections:[
      {name:"General Intelligence & Reasoning", q:50, subject:"Reasoning"},
      {name:"General Knowledge", q:50, subject:"GK"},
      {name:"Quantitative Aptitude", q:50, subject:"Quant"},
      {name:"English", q:50, subject:"English"},
    ]},
    MTS: {title:"SSC MTS (Paper-1 CBT)", durationMin:90, totalQ:90, sections:[
      {name:"Session I (No Negative)", q:45, subject:"MIX"},
      {name:"Session II (-1)", q:45, subject:"MIX"},
    ]},
  };

  const BANK_URL = "./bank/Bank.xlsx";
  const seenKey = "ssc_seen_ids_singlebank_v1";

  let activeExam = "CHSL";
  let bank = [];
  let questions = [];
  let idx = 0;
  let answers = {};
  let review = new Set();
  let endAt = 0;
  let tick = null;

  function getSeenSet(){ try{return new Set(JSON.parse(localStorage.getItem(seenKey)||"[]"));}catch(e){return new Set();} }
  function saveSeenSet(set){ localStorage.setItem(seenKey, JSON.stringify([...set])); }

  function fmtTime(ms){
    ms = Math.max(0, ms);
    const s = Math.floor(ms/1000);
    const hh = String(Math.floor(s/3600)).padStart(2,"0");
    const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
    const ss = String(s%60).padStart(2,"0");
    return `${hh}:${mm}:${ss}`;
  }
  function startTimer(minutes){
    endAt = Date.now() + minutes*60*1000;
    clearInterval(tick);
    tick = setInterval(()=>{
      const left = endAt - Date.now();
      $("timer").textContent = fmtTime(left);
      if(left<=0){ clearInterval(tick); submit(); }
    }, 250);
  }

  function show(id){ $(id).classList.remove("hide"); }
  function hide(id){ $(id).classList.add("hide"); }

  function renderTabs(){
    const t = $("tabs");
    t.innerHTML = "";
    Object.keys(EXAMS).forEach(k=>{
      const b = document.createElement("div");
      b.className = "tab" + (k===activeExam ? " active":"");
      b.textContent = k;
      b.onclick = ()=>{ activeExam=k; renderTabs(); renderPattern(); quickValidate(); };
      t.appendChild(b);
    });
  }

  function renderPattern(){
    const e = EXAMS[activeExam];
    $("patternPill").textContent = `${e.title} | Q: ${e.totalQ} | Time: ${e.durationMin} min`;
    $("instText").innerHTML = `
      <b>${e.title}</b><br/>
      • Total Time: ${e.durationMin} minutes<br/>
      • Total Questions: ${e.totalQ}<br/>
      • Sections: ${e.sections.map(s=>`${s.name} (${s.q})`).join(", ")}<br/><br/>
      Bank: <code>bank/Bank.xlsx</code> | Sheet: <code>QUESTIONS</code><br/>
      Filters: <code>exam=${activeExam}</code> and <code>lang=${$("lang").value}</code>
    `;
  }

  async function loadBank(){
    $("status").textContent = "Loading bank: " + BANK_URL;
    $("validator").textContent = "";
    const res = await fetch(BANK_URL, {cache:"no-store"});
    if(!res.ok) throw new Error("Bank file not found: " + BANK_URL);
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, {type:"array"});
    const ws = wb.Sheets["QUESTIONS"];
    if(!ws) throw new Error("Sheet 'QUESTIONS' not found in Bank.xlsx.");
    bank = XLSX.utils.sheet_to_json(ws, {defval:""});
    $("status").textContent = "Bank loaded ✅ Rows: " + bank.length;
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  function getPool(){
    const lang = $("lang").value;
    const seen = getSeenSet();
    let pool = bank.filter(r=>{
      if(String(r.exam||"").trim() !== activeExam) return false;
      if(String(r.lang||"").trim() !== lang) return false;
      return true;
    });
    return pool.filter(r=>!seen.has(String(r.id)));
  }

  function quickValidate(){
    if(!bank || !bank.length){ $("validator").textContent = ""; return; }
    const lang = $("lang").value;
    const poolAll = bank.filter(r=>String(r.exam||"").trim()===activeExam && String(r.lang||"").trim()===lang);
    if(poolAll.length===0){
      $("validator").textContent = `No rows for exam=${activeExam} and lang=${lang}. Fix Bank.xlsx columns: exam (CHSL/CGL/MTS/STENO/CPO/GD) and lang (EN/HI).`;
      return;
    }
    $("validator").textContent = `OK: Found ${poolAll.length} rows for ${activeExam} (${lang}).`;
  }

  function pickQuestions(){
    const e = EXAMS[activeExam];
    const mode = $("mode").value;
    const pool = getPool();
    shuffle(pool);

    if(mode==="CUSTOM"){
      const count = Math.max(5, Math.min(parseInt($("count").value||"25",10), 200));
      return pool.slice(0,count);
    }

    const out = [];
    for(const s of e.sections){
      let sPool = pool.filter(r=>String(r.section||"").trim()===s.name);

      // fallback if section not matching
      if(sPool.length < s.q && s.subject !== "MIX"){
        sPool = pool.filter(r=>String(r.subject||"").trim()===s.subject);
      }
      shuffle(sPool);
      out.push(...sPool.slice(0, s.q));
    }

    if(out.length < e.totalQ){
      const used = new Set(out.map(x=>String(x.id)));
      const rest = pool.filter(r=>!used.has(String(r.id)));
      out.push(...rest);
    }
    return out.slice(0, e.totalQ);
  }

  function renderPalette(){
    const pal = $("palette");
    pal.innerHTML = "";
    questions.forEach((q,i)=>{
      const b = document.createElement("div");
      b.className = "pbtn";
      b.textContent = i+1;
      if(i===idx) b.classList.add("cur");
      if(answers[q.id]) b.classList.add("ans");
      if(review.has(q.id)) b.classList.add("rev");
      b.onclick = ()=>{ idx=i; renderQ(); };
      pal.appendChild(b);
    });
    $("progress").textContent = `${Object.keys(answers).length}/${questions.length}`;
  }

  function renderQ(){
    const q = questions[idx];
    $("qmeta").innerHTML = `
      <span><b>Q ${idx+1}</b> / ${questions.length}</span>
      <span>${activeExam} | ${$("lang").value}</span>
      <span>Section: ${q.section||"-"}</span>
      <span>Subject: ${q.subject||"-"}</span>
      <span>Marks: ${q.marks}</span>
      <span>Neg: ${q.neg}</span>
    `;
    $("qtext").textContent = q.question;
    const sel = answers[q.id] || "";
    const opts = [["A",q.optA],["B",q.optB],["C",q.optC],["D",q.optD]];
    const wrap = $("opts");
    wrap.innerHTML = "";
    opts.forEach(([k,v])=>{
      const div = document.createElement("div");
      div.className = "opt" + (sel===k ? " sel":"");
      div.innerHTML = `<input type="radio" name="opt" ${sel===k?"checked":""}/>
                       <div><b>${k}.</b> ${v}</div>`;
      div.onclick = ()=>{
        answers[q.id] = k;
        renderQ(); renderPalette();
      };
      wrap.appendChild(div);
    });
    renderPalette();
  }

  function submit(){
    clearInterval(tick);
    const seen = getSeenSet();
    questions.forEach(q=>seen.add(String(q.id)));
    saveSeenSet(seen);

    let correct=0, wrong=0, unatt=0, score=0;
    questions.forEach(q=>{
      const a = answers[q.id];
      if(!a){unatt++; return;}
      const marks = Number(q.marks||1);
      const neg = Number(q.neg||0);
      if(a===q.answer){correct++; score += marks;}
      else{wrong++; score -= neg;}
    });
    const attempted = questions.length - unatt;
    const acc = attempted ? (correct/attempted*100) : 0;

    hide("examUI"); show("resultUI");
    $("rExam").textContent = EXAMS[activeExam].title + " (" + $("lang").value + ")";
    $("rCand").textContent = ($("candName").value||"Candidate") + ( $("roll").value ? " | " + $("roll").value : "");
    $("rTotal").textContent = questions.length;
    $("rCorrect").textContent = correct;
    $("rWrong").textContent = wrong;
    $("rUnatt").textContent = unatt;
    $("rScore").textContent = score.toFixed(2);
    $("rAcc").textContent = acc.toFixed(2) + "%";
  }

  $("prevBtn").onclick = ()=>{ if(idx>0){idx--; renderQ();} };
  $("nextBtn").onclick = ()=>{ if(idx<questions.length-1){idx++; renderQ();} };
  $("markBtn").onclick = ()=>{ const q=questions[idx]; review.has(q.id)?review.delete(q.id):review.add(q.id); renderPalette(); };
  $("clearBtn").onclick = ()=>{ const q=questions[idx]; delete answers[q.id]; renderQ(); renderPalette(); };
  $("submitBtn").onclick = submit;
  $("newBtn").onclick = ()=>{ location.reload(); };
  $("resetSeen").onclick = ()=>{ localStorage.removeItem(seenKey); $("status").textContent="Anti-Repeat reset ✅"; };

  $("mode").onchange = ()=>{
    if($("mode").value==="CUSTOM") $("customCountWrap").classList.remove("hide");
    else $("customCountWrap").classList.add("hide");
  };

  $("goInstructions").onclick = ()=>{ hide("portal"); show("instructions"); renderPattern(); };
  $("backPortal").onclick = ()=>{ hide("instructions"); show("portal"); };

  $("lang").onchange = ()=>{ renderPattern(); quickValidate(); };

  $("startBtn").onclick = async ()=>{
    try{
      if(!bank.length) await loadBank();
      quickValidate();
      const poolAll = bank.filter(r=>String(r.exam||"").trim()===activeExam && String(r.lang||"").trim()===$("lang").value);
      if(poolAll.length===0) throw new Error("No rows for selected exam+language in Bank.xlsx.");
      questions = pickQuestions();
      if(!questions.length) throw new Error("No questions left (Anti-Repeat). Press Reset Anti-Repeat.");
      idx=0; answers={}; review=new Set();
      hide("instructions"); hide("resultUI"); show("examUI");
      startTimer(EXAMS[activeExam].durationMin);
      renderQ();
    }catch(err){
      $("status").textContent = "Error: " + err.message;
      hide("instructions"); show("portal");
    }
  };

  function init(){
    renderTabs();
    renderPattern();
    loadBank().then(()=>quickValidate()).catch(e=>{$("status").textContent="Error: "+e.message;});
  }
  init();
</script>
</body>
</html>
